<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Signal & Stories — Housing</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        window.va = window.va || function () { (window.vaq = window.vaq || []).push(arguments); };
    </script>
    <script defer src="/_vercel/insights/script.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg: #fafafa;
            --bg-card: #ffffff;
            --text: #1a1a1a;
            --text-muted: #666;
            --border: #e5e5e5;
            --up: #16a34a;
            --down: #dc2626;
            --flat: #666;
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --bg: #0a0a0a;
                --bg-card: #141414;
                --text: #fafafa;
                --text-muted: #999;
                --border: #2a2a2a;
                --up: #22c55e;
                --down: #ef4444;
                --flat: #999;
            }
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            line-height: 1.5;
            min-height: 100vh;
            padding: 2rem;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            margin-bottom: 3rem;
        }

        h1 {
            font-size: 1.75rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .tagline {
            color: var(--text-muted);
            font-size: 1rem;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(340px, 1fr));
            gap: 1.5rem;
        }

        .card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.5rem;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }

        .card-title {
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.025em;
        }

        .card-frequency {
            font-size: 0.7rem;
            font-weight: 400;
            text-transform: lowercase;
            opacity: 0.7;
            margin-left: 0.5rem;
        }

        .card-date {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 0.25rem;
        }

        .card-subtitle {
            font-size: 0.8rem;
            color: var(--text-muted);
            font-weight: 400;
            margin-top: 0.25rem;
        }

        .card-title-wrapper {
            position: relative;
            cursor: help;
        }

        .card-tooltip {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 0.75rem;
            font-size: 0.8rem;
            color: var(--text);
            font-weight: 400;
            text-transform: none;
            letter-spacing: normal;
            line-height: 1.5;
            z-index: 10;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            min-width: 280px;
        }

        .card-title-wrapper:hover .card-tooltip {
            display: block;
        }

        .card-value {
            font-size: 2rem;
            font-weight: 600;
            margin: 0.5rem 0;
        }

        .card-trend {
            font-size: 0.875rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .trend-up { color: var(--up); }
        .trend-down { color: var(--down); }
        .trend-flat { color: var(--flat); }

        .chart-container {
            height: 120px;
            margin-top: 1rem;
        }

        .loading {
            color: var(--text-muted);
            font-size: 0.875rem;
        }

        .error {
            color: var(--down);
            font-size: 0.875rem;
        }

        .summary-section {
            margin-bottom: 3rem;
            padding: 1.5rem;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
        }

        .summary-title {
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.025em;
            margin-bottom: 1rem;
        }

        .summary-text {
            font-size: 1.1rem;
            line-height: 1.7;
            margin-bottom: 1.5rem;
        }

        .headlines-title {
            font-size: 0.75rem;
            font-weight: 500;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.025em;
            margin-bottom: 0.75rem;
        }

        .headlines-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .headline-item {
            font-size: 0.875rem;
            line-height: 1.4;
        }

        .headline-item a {
            color: var(--text);
            text-decoration: none;
        }

        .headline-item a:hover {
            text-decoration: underline;
        }

        .headline-source {
            color: var(--text-muted);
            font-size: 0.75rem;
            margin-left: 0.5rem;
        }

        .summary-loading {
            color: var(--text-muted);
            font-style: italic;
        }

        .summary-error {
            color: var(--down);
        }

        .commentary-section {
            margin-top: 3rem;
            margin-bottom: 3rem;
            padding: 1.5rem;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
        }

        .commentary-text {
            font-size: 1.1rem;
            line-height: 1.7;
        }

        .market-watch {
            margin-top: 3rem;
        }

        .section-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .section-subtitle {
            color: var(--text-muted);
            font-size: 0.875rem;
            margin-bottom: 1.5rem;
        }

        .stock-group {
            margin-bottom: 2rem;
        }

        .stock-group-title {
            font-size: 0.8rem;
            font-weight: 500;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.75rem;
        }

        .stock-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1rem;
        }

        .stock-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 1rem 1.25rem;
        }

        .stock-card-header {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            margin-bottom: 0.25rem;
        }

        .stock-ticker {
            font-size: 0.95rem;
            font-weight: 600;
        }

        .stock-name {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .stock-price {
            font-size: 1.25rem;
            font-weight: 600;
        }

        .stock-change {
            font-size: 0.8rem;
            font-weight: 500;
            text-align: right;
        }

        .stock-chart-container {
            height: 60px;
            margin-top: 0.5rem;
        }

        footer {
            margin-top: 3rem;
            padding-top: 2rem;
            border-top: 1px solid var(--border);
            color: var(--text-muted);
            font-size: 0.875rem;
        }

        footer a {
            color: var(--text-muted);
            text-decoration: underline;
        }

        footer a:hover {
            color: var(--text);
        }

        @media (max-width: 480px) {
            body {
                padding: 1rem;
            }
            .grid {
                grid-template-columns: 1fr;
            }
            .card-value {
                font-size: 1.5rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Signal & Stories — Housing</h1>
            <p class="tagline">What the data actually says</p>
        </header>

        <div class="summary-section" id="summary-section">
            <div class="summary-title">Market Summary</div>
            <div class="summary-text summary-loading" id="summary-text">Analyzing market data and news...</div>
            <div class="headlines-title">Recent Headlines</div>
            <div class="headlines-list" id="headlines-list">
                <div class="summary-loading">Loading headlines...</div>
            </div>
        </div>

        <div class="grid" id="dashboard">
            <!-- Cards will be inserted here by JavaScript -->
        </div>

        <div class="commentary-section" id="stock-commentary">
            <div class="summary-title">Stock Market Commentary</div>
            <div class="commentary-text summary-loading" id="commentary-text">Analyzing market impact on housing stocks...</div>
        </div>

        <div class="market-watch" id="market-watch">
            <h2 class="section-title">Market Watch</h2>
            <p class="section-subtitle">Housing-related stocks & ETFs</p>
        </div>

        <footer>
            <p>Data from <a href="https://fred.stlouisfed.org/" target="_blank">FRED</a> (Federal Reserve Bank of St. Louis) and <a href="https://www.alphavantage.co/" target="_blank">Alpha Vantage</a>. Updated as new data is released.</p>
        </footer>
    </div>

    <script>
        const API_BASE = '/api/fred';

        const indicators = [
            {
                id: 'MSPUS',
                name: 'Median Home Price',
                format: 'currency',
                frequency: 'Quarterly',
                subtitle: 'Half of homes sell above, half below',
                tooltip: 'The median sales price of houses sold in the US. Unlike average price, median isn\'t skewed by luxury homes — it shows what a typical buyer actually pays.'
            },
            {
                id: 'EXHOSLUSM495S',
                name: 'Existing Home Sales',
                format: 'unitsToMillions',
                frequency: 'Monthly',
                subtitle: 'Previously owned homes sold',
                tooltip: 'Annual rate of existing (not new) home sales. This is the bulk of the market — about 85% of all home sales. Rising sales = more market activity.'
            },
            {
                id: 'MORTGAGE30US',
                name: '30-Year Mortgage Rate',
                format: 'percent',
                frequency: 'Weekly',
                subtitle: 'Average rate for new loans',
                tooltip: 'The average interest rate for a 30-year fixed mortgage. This directly affects monthly payments and buying power. A 1% rate increase can reduce buying power by ~10%.'
            },
            {
                id: 'MSACSR',
                name: 'Housing Inventory',
                format: 'months',
                frequency: 'Monthly',
                subtitle: 'Months to sell all current homes',
                tooltip: 'How many months it would take to sell all homes on the market at the current sales pace. Under 4 months = seller\'s market, over 6 months = buyer\'s market.'
            },
            {
                id: 'HSN1F',
                name: 'New Home Sales',
                format: 'thousands',
                frequency: 'Monthly',
                subtitle: 'Newly built homes sold',
                tooltip: 'Annual rate of new single-family home sales. A leading indicator of housing demand and construction activity. New homes are about 15% of the market.'
            },
            {
                id: 'HOUST',
                name: 'Housing Starts',
                format: 'thousands',
                frequency: 'Monthly',
                subtitle: 'New construction begun',
                tooltip: 'Annual rate of new housing units where construction has started. A leading economic indicator — builders start construction when they\'re confident about future demand.'
            }
        ];

        function formatValue(value, format) {
            const num = parseFloat(value);
            switch (format) {
                case 'currency':
                    return '$' + num.toLocaleString('en-US', { maximumFractionDigits: 0 });
                case 'percent':
                    return num.toFixed(2) + '%';
                case 'millions':
                    return num.toFixed(2) + ' million';
                case 'unitsToMillions':
                    return (num / 1000000).toFixed(2) + ' million';
                case 'months':
                    return num.toFixed(1) + ' mo';
                case 'thousands':
                    return num.toLocaleString('en-US', { maximumFractionDigits: 0 }) + 'K';
                default:
                    return num.toLocaleString('en-US');
            }
        }

        function formatDate(dateStr) {
            const date = new Date(dateStr);
            return date.toLocaleDateString('en-US', { month: 'short', year: '2-digit' });
        }

        function calculateTrend(data) {
            if (data.length < 2) return { direction: 'flat', change: 0, currentDate: '', previousDate: '' };
            const currentObs = data[data.length - 1];
            const previousObs = data[data.length - 2];
            const current = parseFloat(currentObs.value);
            const previous = parseFloat(previousObs.value);
            const change = ((current - previous) / previous) * 100;

            if (Math.abs(change) < 0.1) return {
                direction: 'flat',
                change: 0,
                currentDate: formatDate(currentObs.date),
                previousDate: formatDate(previousObs.date)
            };
            return {
                direction: change > 0 ? 'up' : 'down',
                change: change,
                currentDate: formatDate(currentObs.date),
                previousDate: formatDate(previousObs.date)
            };
        }

        function getTrendArrow(direction) {
            switch (direction) {
                case 'up': return '↑';
                case 'down': return '↓';
                default: return '→';
            }
        }

        async function fetchFredData(seriesId) {
            const twoYearsAgo = new Date();
            twoYearsAgo.setFullYear(twoYearsAgo.getFullYear() - 2);
            const startDate = twoYearsAgo.toISOString().split('T')[0];

            const url = `${API_BASE}?series_id=${seriesId}&observation_start=${startDate}`;

            const response = await fetch(url);
            if (!response.ok) throw new Error(`HTTP ${response.status}`);

            const data = await response.json();
            return data.observations.filter(obs => obs.value !== '.');
        }

        function createChart(canvas, data, format) {
            const isDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            const gridColor = isDark ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.1)';
            const lineColor = isDark ? '#60a5fa' : '#2563eb';

            const labels = data.map(d => {
                const date = new Date(d.date);
                return date.toLocaleDateString('en-US', { month: 'short', year: '2-digit' });
            });
            const values = data.map(d => parseFloat(d.value));

            new Chart(canvas, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        data: values,
                        borderColor: lineColor,
                        backgroundColor: 'transparent',
                        borderWidth: 2,
                        pointRadius: 0,
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        x: {
                            display: false
                        },
                        y: {
                            display: false
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    }
                }
            });
        }

        function createCard(indicator) {
            const card = document.createElement('div');
            card.className = 'card';
            card.innerHTML = `
                <div class="card-header">
                    <div>
                        <div class="card-title-wrapper">
                            <div class="card-title">${indicator.name} <span class="card-frequency">${indicator.frequency}</span></div>
                            <div class="card-tooltip">${indicator.tooltip}</div>
                        </div>
                        <div class="card-subtitle">${indicator.subtitle}</div>
                        <div class="card-value loading">Loading...</div>
                        <div class="card-trend"></div>
                        <div class="card-date"></div>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="chart-${indicator.id}"></canvas>
                </div>
            `;
            return card;
        }

        async function loadIndicator(indicator, card) {
            const valueEl = card.querySelector('.card-value');
            const trendEl = card.querySelector('.card-trend');
            const dateEl = card.querySelector('.card-date');
            const canvas = card.querySelector('canvas');

            try {
                const data = await fetchFredData(indicator.id);

                if (data.length === 0) throw new Error('No data');

                const latestObs = data[data.length - 1];
                const trend = calculateTrend(data);

                valueEl.textContent = formatValue(latestObs.value, indicator.format);
                valueEl.classList.remove('loading');

                trendEl.className = `card-trend trend-${trend.direction}`;
                trendEl.textContent = `${getTrendArrow(trend.direction)} ${Math.abs(trend.change).toFixed(1)}% from ${trend.previousDate}`;

                dateEl.textContent = `As of ${formatDate(latestObs.date)}`;

                createChart(canvas, data, indicator.format);
            } catch (error) {
                valueEl.textContent = 'Error loading data';
                valueEl.classList.remove('loading');
                valueEl.classList.add('error');
            }
        }

        async function loadSummary() {
            const summaryText = document.getElementById('summary-text');
            const headlinesList = document.getElementById('headlines-list');

            try {
                const response = await fetch('/api/summary');
                if (!response.ok) throw new Error('Failed to load summary');

                const data = await response.json();

                summaryText.textContent = data.summary;
                summaryText.classList.remove('summary-loading');

                headlinesList.innerHTML = data.headlines.map(h => `
                    <div class="headline-item">
                        <a href="${h.url}" target="_blank">${h.title}</a>
                        <span class="headline-source">${h.source}</span>
                    </div>
                `).join('');

            } catch (error) {
                summaryText.textContent = 'Unable to load market summary';
                summaryText.classList.remove('summary-loading');
                summaryText.classList.add('summary-error');
                headlinesList.innerHTML = '<div class="summary-error">Unable to load headlines</div>';
            }
        }

        async function loadStockCommentary() {
            const commentaryText = document.getElementById('commentary-text');

            try {
                const response = await fetch('/api/stock-commentary');
                if (!response.ok) throw new Error('Failed to load commentary');

                const data = await response.json();

                commentaryText.textContent = data.commentary;
                commentaryText.classList.remove('summary-loading');
            } catch (error) {
                commentaryText.textContent = 'Unable to load stock commentary';
                commentaryText.classList.remove('summary-loading');
                commentaryText.classList.add('summary-error');
            }
        }

        // Stock Market Watch
        const STOCK_CACHE_TTL = 15 * 60 * 1000; // 15 minutes
        const STOCK_REQUEST_DELAY = 1500; // 1.5s between API calls

        const stockGroups = [
            { name: 'Homebuilders', tickers: [
                { symbol: 'DHI', name: 'D.R. Horton' },
                { symbol: 'LEN', name: 'Lennar' },
                { symbol: 'PHM', name: 'PulteGroup' }
            ]},
            { name: 'Mortgage & Lending', tickers: [
                { symbol: 'RKT', name: 'Rocket Companies' },
                { symbol: 'UWMC', name: 'UWM Holdings' }
            ]},
            { name: 'REITs & ETFs', tickers: [
                { symbol: 'INVH', name: 'Invitation Homes' },
                { symbol: 'VNQ', name: 'Vanguard Real Estate ETF' },
                { symbol: 'ITB', name: 'iShares Home Construction ETF' }
            ]}
        ];

        function getStockCache(symbol) {
            try {
                const raw = localStorage.getItem(`stock_${symbol}`);
                if (!raw) return null;
                const cached = JSON.parse(raw);
                if (Date.now() - cached.timestamp > STOCK_CACHE_TTL) return null;
                return cached.data;
            } catch {
                return null;
            }
        }

        function setStockCache(symbol, data) {
            try {
                localStorage.setItem(`stock_${symbol}`, JSON.stringify({
                    timestamp: Date.now(),
                    data
                }));
            } catch {
                // localStorage full or unavailable
            }
        }

        async function fetchStockData(symbol) {
            const cached = getStockCache(symbol);
            if (cached) return cached;

            const response = await fetch(`/api/stocks?symbol=${symbol}`);
            if (!response.ok) throw new Error(`HTTP ${response.status}`);

            const data = await response.json();
            setStockCache(symbol, data);
            return data;
        }

        function createStockCard(ticker) {
            const card = document.createElement('div');
            card.className = 'stock-card';
            card.innerHTML = `
                <div class="stock-card-header">
                    <div>
                        <div class="stock-ticker">${ticker.symbol}</div>
                        <div class="stock-name">${ticker.name}</div>
                    </div>
                    <div style="text-align: right">
                        <div class="stock-price loading">—</div>
                        <div class="stock-change"></div>
                    </div>
                </div>
                <div class="stock-chart-container">
                    <canvas id="stock-chart-${ticker.symbol}"></canvas>
                </div>
            `;
            return card;
        }

        function createStockChart(canvas, history) {
            const isDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            const first = history[0].close;
            const last = history[history.length - 1].close;
            const lineColor = last >= first
                ? (isDark ? '#22c55e' : '#16a34a')
                : (isDark ? '#ef4444' : '#dc2626');

            new Chart(canvas, {
                type: 'line',
                data: {
                    labels: history.map(d => {
                        const date = new Date(d.date);
                        return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                    }),
                    datasets: [{
                        data: history.map(d => d.close),
                        borderColor: lineColor,
                        backgroundColor: 'transparent',
                        borderWidth: 1.5,
                        pointRadius: 0,
                        pointHoverRadius: 4,
                        pointHoverBackgroundColor: lineColor,
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                title: (items) => items[0].label,
                                label: (item) => '$' + item.raw.toFixed(2)
                            }
                        }
                    },
                    scales: {
                        x: { display: false },
                        y: { display: false }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    }
                }
            });
        }

        async function loadStockData(ticker, card) {
            const priceEl = card.querySelector('.stock-price');
            const changeEl = card.querySelector('.stock-change');
            const canvas = card.querySelector('canvas');

            try {
                const data = await fetchStockData(ticker.symbol);

                priceEl.textContent = '$' + data.price.toFixed(2);
                priceEl.classList.remove('loading');

                const sign = data.changePercent >= 0 ? '+' : '';
                const arrow = data.changePercent >= 0 ? '↑' : '↓';
                const prevDate = data.history && data.history.length >= 2
                    ? new Date(data.history[data.history.length - 2].date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })
                    : '';
                const vsLabel = prevDate ? ` vs ${prevDate}` : '';
                changeEl.textContent = `${arrow} ${sign}${data.changePercent.toFixed(2)}%${vsLabel}`;
                changeEl.className = `stock-change ${data.changePercent >= 0 ? 'trend-up' : 'trend-down'}`;

                if (data.history && data.history.length > 1) {
                    createStockChart(canvas, data.history);
                }
            } catch {
                priceEl.textContent = '—';
                priceEl.classList.remove('loading');
                changeEl.textContent = 'unavailable';
                changeEl.className = 'stock-change';
                changeEl.style.color = 'var(--text-muted)';
            }
        }

        async function loadMarketWatch() {
            const container = document.getElementById('market-watch');
            const allTickers = [];

            for (const group of stockGroups) {
                const groupEl = document.createElement('div');
                groupEl.className = 'stock-group';
                groupEl.innerHTML = `<div class="stock-group-title">${group.name}</div>`;

                const grid = document.createElement('div');
                grid.className = 'stock-grid';

                for (const ticker of group.tickers) {
                    const card = createStockCard(ticker);
                    grid.appendChild(card);
                    allTickers.push({ ticker, card });
                }

                groupEl.appendChild(grid);
                container.appendChild(groupEl);
            }

            // Stagger API calls to respect rate limits
            for (let i = 0; i < allTickers.length; i++) {
                const { ticker, card } = allTickers[i];
                // If cached, no need to delay
                const cached = getStockCache(ticker.symbol);
                if (cached) {
                    loadStockData(ticker, card);
                } else {
                    if (i > 0) await new Promise(r => setTimeout(r, STOCK_REQUEST_DELAY));
                    loadStockData(ticker, card);
                }
            }
        }

        async function init() {
            const dashboard = document.getElementById('dashboard');

            for (const indicator of indicators) {
                const card = createCard(indicator);
                dashboard.appendChild(card);
                loadIndicator(indicator, card);
            }

            // Load summary after indicators start loading
            loadSummary();

            // Load stock commentary and market watch
            loadStockCommentary();
            loadMarketWatch();
        }

        init();
    </script>
</body>
</html>
